var D=Object.create;var R=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var F=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of M(e))!k.call(n,r)&&r!==t&&R(n,r,{get:()=>e[r],enumerable:!(o=x(e,r))||o.enumerable});return n};var f=(n,e,t)=>(t=n!=null?D(q(n)):{},F(e||!n||!n.__esModule?R(t,"default",{value:n,enumerable:!0}):t,n));var _=f(require("csv-stream")),U=require("fs/promises"),W=f(require("post-entity"));var S=f(require("better-sqlite3")),N=require("fs-extra"),a={},I=n=>(a[n]===void 0&&((0,N.ensureFileSync)(n),a[n]=new S.default(n),a[n].exec("PRAGMA journal_mode = OFF;"),a[n].exec("PRAGMA synchronous = 0;"),a[n].exec("PRAGMA cache_size = 1000000;"),a[n].exec("PRAGMA locking_mode = EXCLUSIVE"),a[n].exec("PRAGMA temp_store = MEMORY;")),a[n]),b=n=>{a[n]=void 0},p=(n,e,t=void 0)=>{let o=n.prepare(e);return t===void 0?o.run():o.bind(t).run()},E=(n,e,t={})=>n.prepare(e).bind(t).all();var y=f(require("wink-nlp")),A=f(require("wink-eng-lite-web-model")),O=require("fs-extra"),G=/'/g,H=/[\n\r]/g,P=1e3*60*60,C=/\$/g,Y=(0,y.default)(A.default),c={createWords:[`CREATE TABLE IF NOT EXISTS words (
     id INTEGER PRIMARY KEY,
     word TEXT UNIQUE
  );`],createWordHistory:[`CREATE TABLE IF NOT EXISTS word_history (
       id INTEGER PRIMARY KEY,
       account_id INTEGER NOT NULL,
       word_id INTEGER NOT NULL,
       timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
       FOREIGN KEY (word_id) REFERENCES words(id)
    );`,"CREATE INDEX IF NOT EXISTS account_idx ON word_history (account_id);","CREATE INDEX IF NOT EXISTS word_idx ON word_history (word_id);"],createAccounts:[`CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT NOT NULL
    );`,"CREATE INDEX IF NOT EXISTS idx_username ON users (username COLLATE NOCASE);"],insertNewWords:"INSERT OR IGNORE INTO words (word) VALUES $$;",insertNewWordHistory:"INSERT INTO word_history (account_id, word_id, timestamp) VALUES (:account_id, :word_id, DATETIME(:timestamp));",insertUser:"INSERT INTO users (username) VALUES (:username);",getNewWords:"SELECT id, word FROM words WHERE word IN $$;",getUser:"SELECT id, username FROM users WHERE username = :username LIMIT 1;",getUniqueWords:`SELECT 
      CAST(strftime('%s', strftime('%Y-%m-%d %H:00:00', timestamp)) AS INT) * 1000 AS hour, 
      COUNT(DISTINCT word_id) AS uniqueCount,
      COUNT(word_id) AS count,
      COUNT(DISTINCT word_id) / COUNT(word_id) AS ratio
    FROM word_history
    WHERE account_id = :account_id
    GROUP BY hour
    ORDER BY hour ASC;`,getWordHistory:`SELECT 
      CAST(strftime('%s', strftime('%Y-%m-%d %H:00:00', timestamp)) AS INT) * 1000 AS hour, 
      word_id
    FROM word_history
    WHERE account_id = :account_id
    ORDER BY hour ASC;`,getWords:"SELECT id, word FROM words;"},w=class{constructor(e=__dirname+"/../../../assets/wordCache.db",t=!0){this.cache={};this.path=e,t&&this.connect(e)}connect(e=this.path){return this.connection=I(e),c.createWords.forEach(t=>this.connection.exec(t)),c.createWordHistory.forEach(t=>this.connection.exec(t)),c.createAccounts.forEach(t=>this.connection.exec(t)),this.populate(),this}getUserId(e){if(typeof e=="number")return e;let t=E(this.connection,c.getUser,{username:e});return t.length>0?t[0].id:p(this.connection,c.insertUser,{username:e}).lastInsertRowid}getReport(e){let t=E(this.connection,c.getUniqueWords,{account_id:e});if(t.length===0)return[];let o=E(this.connection,c.getWordHistory,{account_id:e}),r=t[0].hour,u=t[t.length-1].hour+1,s=[],i=[],d=[];for(;r<u;r+=P){s.push(r);let h=t.find(m=>m.hour===r);h===void 0?(i.push(0),d.push(0)):(i.push(h.uniqueCount),d.push(h.count))}let g=[];return s.map((h,m)=>{let l=0;return o.filter(T=>T.hour===h).forEach(T=>{g.indexOf(T.word_id)===-1&&(l+=1,g.push(T.word_id))}),{hour:h,count:d[m],uniqueCount:i[m],ratio:d[m]===0?0:i[m]/d[m],newGrammar:l}})}reset(){return this.connection&&this.connection.close(),b(this.path),(0,O.rmSync)(this.path),this}addUsages(e,t,o){let r=this.getUserId(t),u=o instanceof Date?o.toISOString().slice(0,-5):o;for(let s of Object.keys(e)){let i=e[s];for(let d=0;d<i.amount;d++)this.addUsage(i.id,r,u)}return r}addUsage(e,t,o){return p(this.connection,c.insertNewWordHistory,{word_id:e,account_id:t,timestamp:o}),this}fetch(e){let t=this.tokenize(e),o=[],r={};for(let s of t)this.cache[s]===void 0?o.push(s):(r[s]===void 0&&(r[s]={id:this.cache[s],amount:0}),r[s].amount+=1);let u=this.getsert(o);for(let s of u)this.cache[s.word]=s.id,r[s.word]===void 0&&(r[s.word]={id:this.cache[s.word],amount:0}),r[s.word].amount+=1;return r}tokenize(e){return Y.readDoc(e.toLowerCase().replace(G,"").replace(H," ")).tokens().out()}populate(){let e=E(this.connection,c.getWords);for(let t of e)this.cache[t.word]=t.id;return this}getsert(e){let t=e instanceof Array?e:this.tokenize(e);if(t.length===0)return[];let o=`('${t.join("'), ('")}')`.replace(C,"S");p(this.connection,c.insertNewWords.replace("$$",o));let r=`('${t.join("', '")}')`.replace(C,"S");return E(this.connection,c.getNewWords.replace("$$",r),{})}toTimeSeries(e,t){let o=[];for(let r of e){let u=r[t];o.push({date:r.hour.toString(),value:u})}return o}};var L=process.argv[2]||"";if(L==="")throw new RangeError;var v={delimiter:"	",endLine:`
`,columnOffset:0,escapeChar:'"',enclosedChar:'"'},X=_.createStream(v);async function $(){let n=new w(`${process.cwd()}/tests/test.db`,!1).reset().connect(),e;(await(0,U.open)(L,"r")).createReadStream().pipe(X).on("data",function(r){if(r.retweet!=="False"||r.language!=="en")return;let u=r.tweet.toLowerCase(),s=W.process(u).filter(i=>i.type==="text").map(i=>i.raw.trim());for(let i of s){let d=n.fetch(i);e=n.addUsages(d,r.username,new Date(r.created_at))}}).on("close",function(){let r=n.getReport(e);console.log(JSON.stringify(r))})}$();
//# sourceMappingURL=index.js.map